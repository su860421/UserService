# .github/workflows/deploy.yml
name: Deploy Laravel to EC2

on:
  push:
    branches:
      - develop

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Parse Production Config
        id: config
        run: |
          # å¾ PRODUCTION_ENV ä¸­æå–é…ç½®
          echo '${{ secrets.PRODUCTION_ENV }}' > /tmp/prod.env
          
          # æå– ECR_REPOSITORYï¼ˆç”¨æ–¼æ§‹å»ºï¼‰
          ECR_REPOSITORY=$(grep '^ECR_REPOSITORY=' /tmp/prod.env | cut -d'=' -f2)
          echo "ecr_repository=$ECR_REPOSITORY" >> $GITHUB_OUTPUT
          
          # é©—è­‰å¿…è¦çš„è®Šæ•¸
          if [[ -z "$ECR_REPOSITORY" ]]; then
            echo "âŒ ECR_REPOSITORY æœªåœ¨ PRODUCTION_ENV ä¸­æ‰¾åˆ°"
            exit 1
          fi
          
          echo "âœ… ECR_REPOSITORY: $ECR_REPOSITORY"

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: âœ… Verify Required Secrets
        run: |
          echo "ğŸ” é©—è­‰ GitHub Secrets..."
          
          if [[ -z "${{ secrets.AWS_ROLE_ARN }}" ]]; then
            echo "âŒ AWS_ROLE_ARN secret æœªè¨­ç½®"
            exit 1
          fi
          
          if [[ -z "${{ secrets.AWS_REGION }}" ]]; then
            echo "âŒ AWS_REGION secret æœªè¨­ç½®"  
            exit 1
          fi
          
          if [[ -z "${{ secrets.EC2_INSTANCE_ID }}" ]]; then
            echo "âŒ EC2_INSTANCE_ID secret æœªè¨­ç½®"
            echo "è«‹è¨­ç½®: EC2_INSTANCE_ID = i-0e328a4cf501724bc"
            exit 1
          fi
          
          if [[ -z "${{ secrets.PRODUCTION_ENV }}" ]]; then
            echo "âŒ PRODUCTION_ENV secret æœªè¨­ç½®"
            exit 1
          fi
          
          echo "âœ… æ‰€æœ‰å¿…è¦çš„ secrets éƒ½å·²è¨­ç½®"
          echo "âœ… EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}"
          echo "âœ… AWS_REGION: ${{ secrets.AWS_REGION }}"

      - name: ğŸ³ Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ğŸ—ï¸ Build, Tag, and Push Image to ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ steps.config.outputs.ecr_repository }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ğŸ—ï¸ æ§‹å»º Docker æ˜ åƒ..."
          docker build --no-cache --pull -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          
          echo "ğŸ“¤ æ¨é€æ˜ åƒåˆ° ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          
          echo "âœ… æ˜ åƒæ¨é€å®Œæˆ"
          echo "image_uri=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: ğŸ“‚ Upload Production Config to EC2
        run: |
          echo "ğŸ“‚ ä¸Šå‚³é…ç½®æ–‡ä»¶åˆ° EC2..."
          
          # å°‡æª”æ¡ˆå…§å®¹ base64 ç·¨ç¢¼
          DOCKER_COMPOSE_B64=$(base64 -w 0 docker-compose.prod.yml)
          NGINX_CONF_B64=$(base64 -w 0 deployment/nginx.prod.conf)
          ENTRYPOINT_B64=$(base64 -w 0 deployment/docker-entrypoint.sh)
          
          # é€é SSM ä¸Šå‚³é…ç½®æ–‡ä»¶
          UPLOAD_CMD_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters commands="[
              \"cd /opt/app\",
              \"mkdir -p deployment\",
              \"echo '$DOCKER_COMPOSE_B64' | base64 -d > docker-compose.prod.yml\",
              \"echo '$NGINX_CONF_B64' | base64 -d > deployment/nginx.prod.conf\",
              \"echo '$ENTRYPOINT_B64' | base64 -d > deployment/docker-entrypoint.sh\",
              \"chmod +x deployment/docker-entrypoint.sh\",
              \"echo 'âœ… é…ç½®æ–‡ä»¶ä¸Šå‚³å®Œæˆ'\"
            ]" \
            --region ${{ secrets.AWS_REGION }} \
            --output text --query 'Command.CommandId')
          
          echo "â³ ç­‰å¾…é…ç½®æ–‡ä»¶ä¸Šå‚³å®Œæˆ (Command ID: $UPLOAD_CMD_ID)..."
          aws ssm wait command-executed \
            --command-id "$UPLOAD_CMD_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --region ${{ secrets.AWS_REGION }}
          
          # æª¢æŸ¥ä¸Šå‚³çµæœ
          UPLOAD_STATUS=$(aws ssm get-command-invocation \
            --command-id "$UPLOAD_CMD_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --region ${{ secrets.AWS_REGION }} \
            --query 'Status' --output text)
          
          if [[ "$UPLOAD_STATUS" == "Success" ]]; then
            echo "âœ… é…ç½®æ–‡ä»¶ä¸Šå‚³æˆåŠŸ"
          else
            echo "âŒ é…ç½®æ–‡ä»¶ä¸Šå‚³å¤±æ•—"
            aws ssm get-command-invocation \
              --command-id "$UPLOAD_CMD_ID" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --region ${{ secrets.AWS_REGION }} \
              --query 'StandardErrorContent' --output text
            exit 1
          fi

      - name: ğŸ” Login to ECR on EC2
        run: |
          echo "ğŸ” åœ¨ EC2 ä¸Šç™»å…¥ ECR..."
          
          ECR_LOGIN_CMD_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters commands="[
              \"cd /opt/app\",
              \"echo 'ğŸ” ç™»å…¥ ECR...'\",
              \"aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}\",
              \"echo 'âœ… ECR ç™»å…¥å®Œæˆ'\"
            ]" \
            --region ${{ secrets.AWS_REGION }} \
            --output text --query 'Command.CommandId')
          
          echo "â³ ç­‰å¾… ECR ç™»å…¥å®Œæˆ (Command ID: $ECR_LOGIN_CMD_ID)..."
          aws ssm wait command-executed \
            --command-id "$ECR_LOGIN_CMD_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --region ${{ secrets.AWS_REGION }}
          
          # æª¢æŸ¥ç™»å…¥çµæœ
          LOGIN_STATUS=$(aws ssm get-command-invocation \
            --command-id "$ECR_LOGIN_CMD_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --region ${{ secrets.AWS_REGION }} \
            --query 'Status' --output text)
          
          if [[ "$LOGIN_STATUS" == "Success" ]]; then
            echo "âœ… ECR ç™»å…¥æˆåŠŸ"
          else
            echo "âŒ ECR ç™»å…¥å¤±æ•—"
            aws ssm get-command-invocation \
              --command-id "$ECR_LOGIN_CMD_ID" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --region ${{ secrets.AWS_REGION }} \
              --query 'StandardErrorContent' --output text
            exit 1
          fi

      - name: âš™ï¸ Setup Environment Variables
        run: |
          echo "âš™ï¸ è¨­ç½®ç’°å¢ƒè®Šæ•¸..."
          
          # å‰µå»ºè‡¨æ™‚è…³æœ¬æ–‡ä»¶ä¾†è™•ç†è¤‡é›œçš„ç’°å¢ƒè®Šæ•¸è¨­ç½®
          cat > /tmp/setup-env.sh << 'SCRIPT_EOF'
          #!/bin/bash
          cd /opt/app
          echo "âš™ï¸ è¨­ç½®ç’°å¢ƒè®Šæ•¸..."
          
          # å‰µå»º .env æ–‡ä»¶
          cat > .env << 'ENV_EOF'
          ${{ secrets.PRODUCTION_ENV }}
          
          # Docker æ˜ åƒè³‡è¨Š
          ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY=${{ steps.config.outputs.ecr_repository }}
          IMAGE_TAG=${{ github.sha }}
          ENV_EOF
          
          echo "âœ… ç’°å¢ƒè®Šæ•¸è¨­ç½®å®Œæˆ"
          echo "ğŸ“„ .env æ–‡ä»¶å¤§å°: $(wc -l < .env) è¡Œ"
          SCRIPT_EOF
          
          # å°‡è…³æœ¬ç·¨ç¢¼ä¸¦ä¸Šå‚³åˆ° EC2
          SCRIPT_B64=$(base64 -w 0 /tmp/setup-env.sh)
          
          SETUP_ENV_CMD_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters commands="[
              \"cd /opt/app\",
              \"echo '$SCRIPT_B64' | base64 -d > setup-env.sh\",
              \"chmod +x setup-env.sh\",
              \"./setup-env.sh\",
              \"rm setup-env.sh\"
            ]" \
            --region ${{ secrets.AWS_REGION }} \
            --output text --query 'Command.CommandId')
          
          echo "â³ ç­‰å¾…ç’°å¢ƒè®Šæ•¸è¨­ç½®å®Œæˆ (Command ID: $SETUP_ENV_CMD_ID)..."
          aws ssm wait command-executed \
            --command-id "$SETUP_ENV_CMD_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --region ${{ secrets.AWS_REGION }}
          
          # æª¢æŸ¥è¨­ç½®çµæœ
          ENV_STATUS=$(aws ssm get-command-invocation \
            --command-id "$SETUP_ENV_CMD_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --region ${{ secrets.AWS_REGION }} \
            --query 'Status' --output text)
          
          if [[ "$ENV_STATUS" == "Success" ]]; then
            echo "âœ… ç’°å¢ƒè®Šæ•¸è¨­ç½®æˆåŠŸ"
          else
            echo "âŒ ç’°å¢ƒè®Šæ•¸è¨­ç½®å¤±æ•—"
            aws ssm get-command-invocation \
              --command-id "$SETUP_ENV_CMD_ID" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --region ${{ secrets.AWS_REGION }} \
              --query 'StandardErrorContent' --output text
            exit 1
          fi

      - name: ğŸ”„ Deploy Application
        run: |
          echo "ğŸ”„ éƒ¨ç½²æ‡‰ç”¨..."
          
          DEPLOY_CMD_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters commands="[
              \"cd /opt/app\",
              \"echo 'ğŸ“ è¨­ç½®é…ç½®æ–‡ä»¶...'\",
              \"cp deployment/nginx.prod.conf nginx.conf\",
              \"cp docker-compose.prod.yml docker-compose.yml\",
              \"echo 'ğŸ›‘ åœæ­¢ç¾æœ‰æœå‹™...'\",
              \"docker-compose down --volumes --remove-orphans || true\",
              \"echo 'ğŸ“¥ æ‹‰å–æ–°æ˜ åƒ...'\",
              \"docker-compose pull\",
              \"echo 'ğŸ”„ å•Ÿå‹•æ‡‰ç”¨...'\",
              \"docker-compose up -d --force-recreate\",
              \"echo 'â³ ç­‰å¾…æœå‹™å•Ÿå‹•...'\",
              \"sleep 60\",
              \"echo 'âœ… æ‡‰ç”¨éƒ¨ç½²å®Œæˆ'\"
            ]" \
            --region ${{ secrets.AWS_REGION }} \
            --output text --query 'Command.CommandId')
          
          echo "â³ ç­‰å¾…æ‡‰ç”¨éƒ¨ç½²å®Œæˆ (Command ID: $DEPLOY_CMD_ID)..."
          aws ssm wait command-executed \
            --command-id "$DEPLOY_CMD_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --region ${{ secrets.AWS_REGION }}
          
          # æª¢æŸ¥éƒ¨ç½²çµæœ
          DEPLOY_STATUS=$(aws ssm get-command-invocation \
            --command-id "$DEPLOY_CMD_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --region ${{ secrets.AWS_REGION }} \
            --query 'Status' --output text)
          
          if [[ "$DEPLOY_STATUS" == "Success" ]]; then
            echo "âœ… æ‡‰ç”¨éƒ¨ç½²æˆåŠŸ"
          else
            echo "âŒ æ‡‰ç”¨éƒ¨ç½²å¤±æ•—"
            aws ssm get-command-invocation \
              --command-id "$DEPLOY_CMD_ID" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --region ${{ secrets.AWS_REGION }} \
              --query 'StandardErrorContent' --output text
            exit 1
          fi

      - name: ğŸ§¹ Post-deployment Tasks
        run: |
          echo "ğŸ§¹ åŸ·è¡Œéƒ¨ç½²å¾Œä»»å‹™..."
          
          POST_DEPLOY_CMD_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters commands="[
              \"cd /opt/app\",
              \"echo 'ğŸ§¹ æ¸…é™¤ Laravel ç¼“å­˜...'\",
              \"docker exec laravel-app php artisan config:clear 2>/dev/null || true\",
              \"docker exec laravel-app php artisan cache:clear 2>/dev/null || true\",
              \"docker exec laravel-app php artisan route:clear 2>/dev/null || true\",
              \"docker exec laravel-app php artisan view:clear 2>/dev/null || true\",
              \"echo 'ğŸ” æª¢æŸ¥ç’°å¢ƒè®Šæ•¸åŠ è¼‰ç‹€æ³...'\",
              \"docker exec laravel-app env | grep -E '(APP_|DB_|REDIS_|AUTH_|JWT_|CACHE_|SESSION_|QUEUE_)' | sort || true\",
              \"echo 'ğŸ“Š æª¢æŸ¥æœå‹™ç‹€æ…‹...'\",
              \"docker-compose ps\",
              \"echo 'ğŸ§¹ æ¸…ç†èˆŠæ˜ åƒ...'\",
              \"docker image prune -af --filter 'until=24h'\",
              \"echo 'âœ… éƒ¨ç½²å¾Œä»»å‹™å®Œæˆ'\"
            ]" \
            --region ${{ secrets.AWS_REGION }} \
            --output text --query 'Command.CommandId')
          
          echo "â³ ç­‰å¾…éƒ¨ç½²å¾Œä»»å‹™å®Œæˆ (Command ID: $POST_DEPLOY_CMD_ID)..."
          aws ssm wait command-executed \
            --command-id "$POST_DEPLOY_CMD_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --region ${{ secrets.AWS_REGION }}
          
          # æª¢æŸ¥ä»»å‹™çµæœ
          POST_STATUS=$(aws ssm get-command-invocation \
            --command-id "$POST_DEPLOY_CMD_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --region ${{ secrets.AWS_REGION }} \
            --query 'Status' --output text)
          
          if [[ "$POST_STATUS" == "Success" ]]; then
            echo "âœ… éƒ¨ç½²å¾Œä»»å‹™å®Œæˆ"
          else
            echo "âš ï¸ éƒ¨ç½²å¾Œä»»å‹™éƒ¨åˆ†å¤±æ•—ï¼ˆæ‡‰ç”¨å¯èƒ½ä»æ­£å¸¸é‹è¡Œï¼‰"
            aws ssm get-command-invocation \
              --command-id "$POST_DEPLOY_CMD_ID" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --region ${{ secrets.AWS_REGION }} \
              --query 'StandardErrorContent' --output text
          fi

      - name: ğŸ¥ Health Check
        run: |
          echo "ğŸ¥ åŸ·è¡Œå¥åº·æª¢æŸ¥..."
          
          HEALTH_CHECK_CMD_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters commands="[
              \"cd /opt/app\",
              \"echo 'ğŸ¥ é–‹å§‹å¥åº·æª¢æŸ¥...'\",
              \"max_attempts=12\",
              \"attempt=0\",
              \"success=false\",
              \"while [ \\$attempt -lt \\$max_attempts ]; do\",
              \"  if curl -f http://localhost/health >/dev/null 2>&1; then\",
              \"    echo 'âœ… æ‡‰ç”¨å¥åº·æª¢æŸ¥é€šé (/health)'\",
              \"    success=true\",
              \"    break\",
              \"  elif curl -f http://localhost/api/v1/health-check >/dev/null 2>&1; then\",
              \"    echo 'âœ… API å¥åº·æª¢æŸ¥é€šé (/api/v1/health-check)'\",
              \"    success=true\",
              \"    break\",
              \"  elif curl -f http://localhost >/dev/null 2>&1; then\",
              \"    echo 'âœ… æ‡‰ç”¨åŸºæœ¬å¯ç”¨ (/)'\",
              \"    success=true\",
              \"    break\",
              \"  fi\",
              \"  attempt=\\$((attempt + 1))\",
              \"  echo 'â³ å¥åº·æª¢æŸ¥å˜—è©¦ '\\$attempt'/'\\$max_attempts'...'\",
              \"  sleep 10\",
              \"done\",
              \"if [ \\$success = false ]; then\",
              \"  echo 'âŒ å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œæª¢æŸ¥æœå‹™ç‹€æ…‹...'\",
              \"  echo '=== Docker Compose ç‹€æ…‹ ==='\",
              \"  docker-compose ps\",
              \"  echo '=== App å®¹å™¨æ—¥èªŒ (æœ€å¾Œ 20 è¡Œ) ==='\",
              \"  docker-compose logs --tail=20 app || true\",
              \"  echo '=== Nginx å®¹å™¨æ—¥èªŒ (æœ€å¾Œ 10 è¡Œ) ==='\",
              \"  docker-compose logs --tail=10 nginx || true\",
              \"  echo '=== æª¢æŸ¥ .env æ–‡ä»¶ ==='\",
              \"  ls -la .env\",
              \"  exit 1\",
              \"fi\",
              \"echo 'ğŸ‰ å¥åº·æª¢æŸ¥å®Œæˆï¼'\"
            ]" \
            --region ${{ secrets.AWS_REGION }} \
            --output text --query 'Command.CommandId')
          
          echo "â³ ç­‰å¾…å¥åº·æª¢æŸ¥å®Œæˆ (Command ID: $HEALTH_CHECK_CMD_ID)..."
          aws ssm wait command-executed \
            --command-id "$HEALTH_CHECK_CMD_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --region ${{ secrets.AWS_REGION }}
          
          # æª¢æŸ¥å¥åº·æª¢æŸ¥çµæœ
          HEALTH_STATUS=$(aws ssm get-command-invocation \
            --command-id "$HEALTH_CHECK_CMD_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --region ${{ secrets.AWS_REGION }} \
            --query 'Status' --output text)
          
          if [[ "$HEALTH_STATUS" == "Success" ]]; then
            echo "âœ… å¥åº·æª¢æŸ¥é€šé"
            # é¡¯ç¤ºå¥åº·æª¢æŸ¥çš„è©³ç´°è¼¸å‡º
            aws ssm get-command-invocation \
              --command-id "$HEALTH_CHECK_CMD_ID" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --region ${{ secrets.AWS_REGION }} \
              --query 'StandardOutputContent' --output text
          else
            echo "âŒ å¥åº·æª¢æŸ¥å¤±æ•—"
            # é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
            aws ssm get-command-invocation \
              --command-id "$HEALTH_CHECK_CMD_ID" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --region ${{ secrets.AWS_REGION }} \
              --query 'StandardErrorContent' --output text
            exit 1
          fi

      - name: ğŸ‰ Deployment Complete
        run: |
          echo ""
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo ""
          echo "ğŸ“Š éƒ¨ç½²æ‘˜è¦ï¼š"
          echo "âœ… Docker æ˜ åƒ: ${{ steps.login-ecr.outputs.registry }}/${{ steps.config.outputs.ecr_repository }}:${{ github.sha }}"
          echo "âœ… ç›®æ¨™å¯¦ä¾‹: ${{ secrets.EC2_INSTANCE_ID }}"
          echo "âœ… éƒ¨ç½²å€åŸŸ: ${{ secrets.AWS_REGION }}"
          echo "âœ… å¥åº·æª¢æŸ¥: é€šé"
          echo ""
          echo "ğŸ”— æª¢æŸ¥ç‹€æ…‹ï¼š"
          echo "   SSH åˆ° EC2 åŸ·è¡Œ: /opt/app/check-status.sh"
          echo "   æˆ–åŸ·è¡Œ: /opt/app/test-ssm.sh"
          echo ""
          echo "ğŸ“ éƒ¨ç½²è©³æƒ…ï¼š"
          echo "   æäº¤ SHA: ${{ github.sha }}"
          echo "   åˆ†æ”¯: ${{ github.ref_name }}"
          echo "   è§¸ç™¼è€…: ${{ github.actor }}"
          echo "   å·¥ä½œæµç¨‹: ${{ github.run_number }}"