# .github/workflows/deploy.yml
name: Deploy Laravel to EC2

on:
  push:
    branches:
      - develop

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”§ Parse Production Config
        id: config
        run: |
          # å¾ž PRODUCTION_ENV ä¸­æå–é…ç½®
          echo '${{ secrets.PRODUCTION_ENV }}' > /tmp/prod.env
          
          # æå– ECR_REPOSITORYï¼ˆç”¨æ–¼æ§‹å»ºï¼‰
          ECR_REPOSITORY=$(grep '^ECR_REPOSITORY=' /tmp/prod.env | cut -d'=' -f2)
          echo "ecr_repository=$ECR_REPOSITORY" >> $GITHUB_OUTPUT

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ðŸ³ Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ðŸ—ï¸ Build, Tag, and Push Image to ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ steps.config.outputs.ecr_repository }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ðŸ—ï¸ æ§‹å»º Docker æ˜ åƒ..."
          docker build --no-cache --pull -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          
          echo "ðŸ“¤ æŽ¨é€æ˜ åƒåˆ° ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          
          echo "âœ… æ˜ åƒæŽ¨é€å®Œæˆ"
          echo "image_uri=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: ðŸ“‚ Upload Production Config to EC2
        run: |
          # é€éŽ SSM ä¸Šå‚³é…ç½®æ–‡ä»¶ï¼ˆå–ä»£ SCPï¼‰
          echo "ðŸ“‚ ä¸Šå‚³é…ç½®æ–‡ä»¶åˆ° EC2..."
          
          # å°‡æª”æ¡ˆå…§å®¹ base64 ç·¨ç¢¼
          DOCKER_COMPOSE_CONTENT=$(base64 -w 0 docker-compose.prod.yml)
          NGINX_CONF_CONTENT=$(base64 -w 0 deployment/nginx.prod.conf)
          ENTRYPOINT_CONTENT=$(base64 -w 0 deployment/docker-entrypoint.sh)
          
          # é€éŽ SSM é‡å»ºæ–‡ä»¶
          aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[
              'cd /opt/app',
              'mkdir -p deployment',
              'echo \"$DOCKER_COMPOSE_CONTENT\" | base64 -d > docker-compose.prod.yml',
              'echo \"$NGINX_CONF_CONTENT\" | base64 -d > deployment/nginx.prod.conf', 
              'echo \"$ENTRYPOINT_CONTENT\" | base64 -d > deployment/docker-entrypoint.sh',
              'chmod +x deployment/docker-entrypoint.sh'
            ]" \
            --region ${{ secrets.AWS_REGION }} > /dev/null

      - name: ðŸš€ Deploy to EC2
        run: |
          # é€éŽ SSM åŸ·è¡Œéƒ¨ç½²ï¼ˆå–ä»£ SSHï¼‰
          echo "ðŸš€ é–‹å§‹éƒ¨ç½²..."
          
          aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[
              'cd /opt/app',
              '',
              'echo \"ðŸ” ç™»å…¥ ECR...\"',
              'aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}',
              '',
              'echo \"âš™ï¸ è¨­ç½®ç’°å¢ƒè®Šæ•¸...\"',
              'echo '\''${{ secrets.PRODUCTION_ENV }}'\'' > .env',
              '',
              'echo \"\" >> .env',
              'echo \"# Docker æ˜ åƒè³‡è¨Š\" >> .env',
              'echo \"ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}\" >> .env',
              'echo \"ECR_REPOSITORY=${{ steps.config.outputs.ecr_repository }}\" >> .env',
              'echo \"IMAGE_TAG=${{ github.sha }}\" >> .env',
              '',
              'echo \"ðŸ“ è¨­ç½®é…ç½®æ–‡ä»¶...\"',
              'cp deployment/nginx.prod.conf nginx.conf',
              'cp docker-compose.prod.yml docker-compose.yml',
              '',
              'echo \"ðŸ›‘ åœæ­¢ç¾æœ‰æœå‹™...\"',
              'docker-compose down --volumes --remove-orphans || true',
              '',
              'echo \"ðŸ“¥ æ‹‰å–æ–°æ˜ åƒ...\"',
              'docker-compose pull',
              '',
              'echo \"ðŸ”„ éƒ¨ç½²æ‡‰ç”¨...\"',
              'docker-compose up -d --force-recreate',
              '',
              'echo \"â³ ç­‰å¾…æœå‹™å•Ÿå‹•...\"',
              'sleep 60',
              '',
              'echo \"ðŸ§¹ æ¸…é™¤ Laravel ç¼“å­˜...\"',
              'docker exec laravel-app php artisan config:clear 2>/dev/null || true',
              'docker exec laravel-app php artisan cache:clear 2>/dev/null || true',
              'docker exec laravel-app php artisan route:clear 2>/dev/null || true',
              'docker exec laravel-app php artisan view:clear 2>/dev/null || true',
              '',
              'echo \"ðŸ” æª¢æŸ¥ç’°å¢ƒè®Šæ•¸åŠ è¼‰ç‹€æ³...\"',
              'echo \"å®¹å™¨å…§çš„é—œéµç’°å¢ƒè®Šæ•¸ï¼š\"',
              'docker exec laravel-app env | grep -E \"(APP_|DB_|REDIS_|AUTH_|JWT_|CACHE_|SESSION_|QUEUE_)\" | sort || true',
              '',
              'echo \"ðŸ¥ å¥åº·æª¢æŸ¥...\"',
              'max_attempts=12',
              'attempt=0',
              '',
              'while [ \$attempt -lt \$max_attempts ]; do',
              '  if curl -f http://localhost/health >/dev/null 2>&1; then',
              '    echo \"âœ… æ‡‰ç”¨å¥åº·æª¢æŸ¥é€šéŽ\"',
              '    break',
              '  elif curl -f http://localhost/api/v1/health-check >/dev/null 2>&1; then',
              '    echo \"âœ… API å¥åº·æª¢æŸ¥é€šéŽ\"',
              '    break',
              '  elif curl -f http://localhost >/dev/null 2>&1; then',
              '    echo \"âœ… æ‡‰ç”¨åŸºæœ¬å¯ç”¨\"',
              '    break',
              '  fi',
              '  ',
              '  attempt=\$((attempt + 1))',
              '  echo \"â³ å¥åº·æª¢æŸ¥å˜—è©¦ \$attempt/\$max_attempts...\"',
              '  sleep 10',
              'done',
              '',
              'if [ \$attempt -eq \$max_attempts ]; then',
              '  echo \"âŒ å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œæª¢æŸ¥æœå‹™ç‹€æ…‹...\"',
              '  echo \"=== Docker Compose ç‹€æ…‹ ===\"',
              '  docker-compose ps',
              '  echo \"=== App å®¹å™¨æ—¥èªŒ ===\"',
              '  docker-compose logs --tail=50 app',
              '  echo \"=== Redis å®¹å™¨æ—¥èªŒ ===\"',
              '  docker-compose logs --tail=20 redis',
              '  echo \"=== MySQL å®¹å™¨æ—¥èªŒ ===\"',
              '  docker-compose logs --tail=20 db',
              '  echo \"=== æª¢æŸ¥ .env æ–‡ä»¶ ===\"',
              '  ls -la .env',
              '  echo \"=== .env æ–‡ä»¶å…§å®¹ï¼ˆå‰20è¡Œï¼‰===\"',
              '  head -20 .env',
              '  exit 1',
              'fi',
              '',
              'echo \"ðŸ“Š æœ€çµ‚æœå‹™ç‹€æ…‹ï¼š\"',
              'docker-compose ps',
              '',
              'echo \"ðŸ§¹ æ¸…ç†èˆŠæ˜ åƒ...\"',
              'docker image prune -af --filter \"until=24h\"',
              '',
              'echo \"ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼\"'
            ]" \
            --region ${{ secrets.AWS_REGION }} > /dev/null