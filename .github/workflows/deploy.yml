# .github/workflows/deploy.yml
name: Deploy Laravel to EC2

on:
  push:
    branches:
      - master

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Parse Production Config
        id: config
        run: |
          # å¾ PRODUCTION_ENV ä¸­æå–é…ç½®
          echo '${{ secrets.PRODUCTION_ENV }}' > /tmp/prod.env
          
          # æå– EC2_HOSTï¼ˆç”¨æ–¼å¾ŒçºŒæ­¥é©Ÿï¼‰
          EC2_HOST=$(grep '^EC2_HOST=' /tmp/prod.env | cut -d'=' -f2)
          echo "ec2_host=$EC2_HOST" >> $GITHUB_OUTPUT
          
          # æå– ECR_REPOSITORYï¼ˆç”¨æ–¼æ§‹å»ºï¼‰
          ECR_REPOSITORY=$(grep '^ECR_REPOSITORY=' /tmp/prod.env | cut -d'=' -f2)
          echo "ecr_repository=$ECR_REPOSITORY" >> $GITHUB_OUTPUT

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ğŸ³ Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ğŸ—ï¸ Build, Tag, and Push Image to ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ steps.config.outputs.ecr_repository }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ğŸ—ï¸ æ§‹å»º Docker æ˜ åƒ..."
          docker build --no-cache --pull -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          
          echo "ğŸ“¤ æ¨é€æ˜ åƒåˆ° ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          
          echo "âœ… æ˜ åƒæ¨é€å®Œæˆ"
          echo "image_uri=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: ğŸ“‚ Upload Production Config to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ steps.config.outputs.ec2_host }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          source: "docker-compose.prod.yml,deployment/nginx.prod.conf"
          target: "/opt/app/"

      - name: ğŸš€ Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ steps.config.outputs.ec2_host }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            cd /opt/app
            
            echo "ğŸ” ç™»å…¥ ECR..."
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | \
              docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}
            
            echo "âš™ï¸ è¨­ç½®ç’°å¢ƒè®Šæ•¸..."
            # ç›´æ¥ä½¿ç”¨å®Œæ•´çš„ç”Ÿç”¢ç’°å¢ƒé…ç½®
            cat > .env << 'EOF'
            ${{ secrets.PRODUCTION_ENV }}
            
            # å‹•æ…‹æ·»åŠ  Docker æ˜ åƒè³‡è¨Š
            ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
            IMAGE_TAG=${{ steps.build-image.outputs.image_uri }}
            EOF
            
            echo "ğŸ“ è¨­ç½®é…ç½®æ–‡ä»¶..."
            # ä½¿ç”¨ç”Ÿç”¢ç’°å¢ƒçš„ nginx é…ç½®
            cp deployment/nginx.prod.conf nginx.conf
            
            # ä½¿ç”¨ç”Ÿç”¢ç’°å¢ƒçš„ docker-compose é…ç½®
            cp docker-compose.prod.yml docker-compose.yml
            
            echo "ğŸ“¥ æ‹‰å–æ–°æ˜ åƒ..."
            docker-compose pull
            
            echo "ğŸ”„ éƒ¨ç½²æ‡‰ç”¨..."
            docker-compose up -d --force-recreate
            
            echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹•..."
            sleep 45
            
            echo "ğŸ¥ å¥åº·æª¢æŸ¥..."
            max_attempts=12
            attempt=0
            
            while [ $attempt -lt $max_attempts ]; do
              if curl -f http://localhost/health >/dev/null 2>&1; then
                echo "âœ… æ‡‰ç”¨å¥åº·æª¢æŸ¥é€šé"
                break
              elif curl -f http://localhost >/dev/null 2>&1; then
                echo "âœ… æ‡‰ç”¨åŸºæœ¬å¯ç”¨"
                break
              fi
              
              attempt=$((attempt + 1))
              echo "â³ å¥åº·æª¢æŸ¥å˜—è©¦ $attempt/$max_attempts..."
              sleep 10
            done
            
            if [ $attempt -eq $max_attempts ]; then
              echo "âŒ å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œæª¢æŸ¥æœå‹™ç‹€æ…‹..."
              docker-compose ps
              docker-compose logs --tail=50 app
              exit 1
            fi
            
            echo "ğŸ“Š æœ€çµ‚æœå‹™ç‹€æ…‹ï¼š"
            docker-compose ps
            
            echo "ğŸ§¹ æ¸…ç†èˆŠæ˜ åƒ..."
            docker image prune -af --filter "until=24h"
            
            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"